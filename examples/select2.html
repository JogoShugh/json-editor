<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>SpaceMiner World Editor</title>
    <script src="../dist/jsoneditor.js"></script>
    <script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script src="//cdn.jsdelivr.net/select2/3.4.8/select2.min.js"></script>
    <link rel="stylesheet" href="//cdn.jsdelivr.net/select2/3.4.8/select2.css">
    <script src='//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.7.0/underscore-min.js'></script>
    <script src='//maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js'></script>
    <link rel='stylesheet' href='//maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css'>
    <link rel='stylesheet' href='//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.3.0/css/font-awesome.min.css'>
    <script data-require="handlebars.js@1.3.0" data-semver="1.3.0" src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/1.3.0/handlebars.js"></script>
    <script src='//cdn.jsdelivr.net/ace/1.1.8/min/ace.js'></script>
    <script src='//cdn.jsdelivr.net/ace/1.1.8/min/ext-beautify.js'></script>
    <script src='//cdn.jsdelivr.net/ace/1.1.8/min/mode-javascript.js'></script>
    <script src='//cdn.jsdelivr.net/ace/1.1.8/min/theme-monokai.js'></script>
    <style>
.worldContainer {
  text-align: center;
}

.worldMap {
  display: table;
  border-collapse: collapse;
  border: none;
  margin-left: auto;
  margin-right: auto;
  margin-top: 5px;
}

.worldRow {
  display: table-row;
  border: none;
}

.worldCell {
  position: relative;
  background-color: black;
  height: 30px;
  min-height: 30px;
  width: 30px;
  min-width: 30px;
  text-align: center;
  display: table-cell;  
  border-collapse: collapse;
}

.worldCellBorder {
  border: 1px solid lightgray;
}

.worldCellCoords:after {
  position: relative;
  top: 10px;
  content: attr(data-coords);
  padding: 1px;
  font-size: 70%;
  font-weight: bold;
  color: black;
  background-color: white;
  opacity: .8;
}

#levelBoardCode { 
    position: relative;
    width: 632px;
    height: 250px;
}


    </style>
    <script id="templateHeader" type="text/x-handlebars-template">
<section class='gameHeader'>
  <h2>{{worldName}}</h2>
  <h4>explored by {{explorerName}}</h4>
  <div>Lives remaining: {{numberOfLives}}</div>
  <div>Enemies respawn: {{toString enableEnemyRespawn}}</div>
  <button class='btn btn-xs btn-primary' id='toggleGrid'>Toggle grid</button>&nbsp;<button class='btn btn-xs btn-primary' id='toggleCoords'>Toggle coordinates</button>
</section>
    </script>    
    <style type='text/css'>
body {
  padding: 5px;
}

.select2-container.form-control {
    height: 58px;
}

.select2-container .select2-choice {
    padding: 2px;
    padding-right: 4px;
    padding-bottom: 2px;
    height: 20px;
    vertical-align: middle;
    background-color: black;
    display: table-cell;
}    
    </style>
  </head>
  <body>

    <div id='editor_holder'></div>    
    <button id='submit'>Show world code in console</button>
    
    <div class="modal fade" id="tileDialog" tabindex="-1" role="dialog" aria-labelledby="tileDialogLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            <h4 class="modal-title" id="tileDialogLabel">Select tile</h4>
          </div>       
          
          <div class="modal-body">          
            <img id="tileTile" class="tileSelector" data-spriteLetter="t" />&nbsp;
            <img id="tileCoin" class="tileSelector" data-spriteLetter="c" />&nbsp;
            <img id="tileGem" class="tileSelector" data-spriteLetter="g" />&nbsp;
            <img id="tileEnemy" class="tileSelector" data-spriteLetter="e" />&nbsp;
            <img id="tilePlayer" class="tileSelector" data-spriteLetter="p" />&nbsp;
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
          </div>
        </div>
      </div>
    </div>

    <script>
/* begin editor */

JSONEditor.defaults.editors.world = JSONEditor.AbstractEditor.extend({
  getDefaults: function(world, sprites) {
    return {
      world: world,
      drawWorldCell: function(cell, rowNum, cellNum) {
        var spritesMap = {
          t : 'tile',
          p : 'player',
          e : 'enemy',
          g : 'gem',
          c : 'coin'
        };
        var spriteName = sprites[spritesMap[cell]];
        if (!spriteName) {
          spriteName = this.sprites[spritesMap[cell]];
        }
        //var file = spritesMap[cell] + '/' + spriteName;
        var file = spriteName;
        return '<span class="worldCell" data-coords="' + rowNum + ':' + cellNum + '" style="background-image: url(http://spaceminer.mod.bz/images/spriteParts/' + file + ');"></span>';
      },
      drawWorldRow: function(row, rowNum) {
        var rowHtml = "<div class='worldRow'>";
        var that = this;
        row.forEach(function(cell, cellNum) {
          rowHtml += that.drawWorldCell(cell, rowNum, cellNum);
        });
        return rowHtml + '</div>\n';
      },
      drawWorld: function(world) {
        var worldHtml = '';
        var that = this;
        if (!_.isArray(world)) throw "world must be a valid array";
        if (world.length === 0) {
          world = defaults.world;
        }
        var worldCopy = JSON.parse(JSON.stringify(this.world));

        function copyRow(rowSource, rowTarget) {
          rowSource.forEach(function(cell, index) {
            rowTarget[index] = cell;
          });
        }
        if (_.isArray(world[0])) {
          world.forEach(function(row, rowIndex) {
            copyRow(row, worldCopy[rowIndex]);
          });
        } else {
          copyRow(world, worldCopy[0]);
        }
        // Now assure left and right borders are all tiles
        worldCopy.forEach(function(row) {
          row.push('t');
          row.unshift('t');
        });
        // And, the top and bottom rows are all tiles
        var borderRow = 'ttttttttttttttttttttt'.split('');
        worldCopy.push(borderRow);
        worldCopy.unshift(borderRow);

        worldCopy.forEach(function(row, rowNum) {
          worldHtml += that.drawWorldRow(row, rowNum);
        });
        return worldHtml;
      }
    };
  },
  build: function() {
    var that = this;

    var worldContainer = $("<div></div>");
    this.worldContainer = worldContainer;
    this.worldContainer.append($("<div></div>"));
    this.control = this.theme.getFormControl(this.label, worldContainer[0], this.description);
    this.container.appendChild(this.control);
    this.container.appendChild($('<div class="editor" id="levelBoardCode"></div>')[0]);

    var editor = ace.edit('levelBoardCode');
    editor.setFontSize(16);
    editor.setTheme('ace/theme/monokai');
    editor.setHighlightActiveLine(true);
    var session = editor.getSession();
    session.setMode('ace/mode/text');

    var worldFromText = function(worldText) {
        var world = _.map(worldText.split('\n'), function(row) {
            row = row.toLowerCase();
            var rowArray = row.split('');
            if (rowArray.length > 19) {
              rowArray = rowArray.slice(0, 19);
            }
            if (rowArray.length < 19) {
              for(var i = rowArray.length; i < 19; i++) {
                rowArray[i] = 't';
              }
            }

            rowArray = _.map(rowArray, function(cell) {
              if ('tacgep'.indexOf(cell) < 0) {
                return 't';
              } else {
                return cell;
              }
            });

            return rowArray;
        });
        if (world.length > 12) world = world.slice(0, 12);
        return world;
    };

    var timeoutId = null;
    function onChange() {
        if (timeoutId !== null) clearTimeout(timeoutId);
        timeoutId = setTimeout(function() {
            var world = worldFromText(editor.getValue());
            that.is_dirty = true;
            that.setValue(world);
            that.watch_listener();
            that.jsoneditor.notifyWatchers(this.path);
        }, 1250);
    }

    editor.on('change', onChange, 1000);

    that.jsoneditor.watch('root.sprites', function() {
      that.refreshValue();
    });
  },
  getValue: function() {
    return this.value;
  },
  refreshValue: function() {

    var spritesEditor = this.jsoneditor.getEditor('root.sprites');
    var val = this.getValue();
    var that = this;
    var sprites = spritesEditor.getValue();
    this.worldContainer.empty();
    this.worldContainer.append(this.getDefaults(val, sprites).drawWorld(val));    

    var editor = ace.edit('levelBoardCode');
    var session = editor.getSession();

    var worldData = '';
    _.each(val, function(row) {
      _.each(row, function(cell) {
        worldData += cell;
      });
      worldData += '\n';
    });

    worldData = worldData.substring(0, worldData.length - 1);

    if (session.getValue() !== worldData) session.setValue(worldData);
    
    this.worldContainer.find('.worldCell').click(function() {
      var sprites = spritesEditor.getValue();
      var clicked = this;

      var pos = $(clicked).attr('data-coords').split(':');
      var row = Number(pos[0]),
          col = Number(pos[1]);
      if (row === 0 || row === 13 || col === 0 || col === 20) return;

      var spriteSrc = 'http://spaceminer.mod.bz/images/spriteParts/';
      $("#tileTile").attr('src', spriteSrc + sprites.tile);
      $("#tileCoin").attr('src', spriteSrc + sprites.coin);
      $("#tileGem").attr('src', spriteSrc + sprites.gem);
      $("#tileEnemy").attr('src', spriteSrc + sprites.enemy);    
      $("#tilePlayer").attr('src', spriteSrc + sprites.player);

      $('[class=tileSelector]').off('click');
      $('[class=tileSelector]').on('click', function() {
        var spriteLetter = $(this).attr('data-spriteLetter');
        var world = that.value;
        row--;
        col--;
        world[row][col] = spriteLetter;        
        that.setValue(world);
        $('#')
        $('#tileDialog').modal('hide');
        /*
        board[row][col] = spriteLetter;
        var text = boardToText(board);      
        var editor = ace.edit('levelBoard');
        editor.getSession().setValue(text);
        editor.resize();
        updateLevelPreviews();
        */
      });

      $('#tileDialog').modal('show');    
    });
  },
  setValue: function(val) {
    this.value = val;    
    this.refreshValue();
    if(this.jsoneditor) {
      this.jsoneditor.notifyWatchers(this.path);
      if(this.parent) this.parent.onChildEditorChange(this);
      else this.jsoneditor.onChange();
    }    
  }
});

JSONEditor.defaults.resolvers.unshift(function(schema) {
  if(schema.type === "array" && schema.format === "world") return "world";
});

/* end editor */

var schema = {
  type: "object",
  title: "SpaceMiner world settings",
  options: { disable_collapse: true, collapsed: false },
  properties: {
    "basics": {
      "type": "object",
      "title": "Basic settings",
      "description": "Specify world and player properties and behaviors",
      "options" : { collapsed: true },
      "properties": {
        "worldName": {
          "type": "string",
          "title": "World name",
          "description": "Your world's name",
          "minLength": 3,
          "maxLength": 25,
          "placeholder": "Space Miner"
        },
        "explorerName": {
          "type": "string",
          "title": "Explorer name",
          "description": "Claim yourself as this world's explorer!",
          "default": "Ninja Coder",
          "minLength": 2,
          "maxLength": 50
        },
        "numberOfLives": {
          "type": "integer",
          "default": 1,
          "minimum": 1,
          "maximum": 10,
          "title": "Number of lives",
          "description": "Specifies the number of times miners can come back to life after enemies destroy them",
          "headerTemplate": "Number of lives: {{self}}",
          "format": "range"
        }
      }
    },
    "enemy": {
      "type": "object",
      "title": "Enemy settings",
      "description": "Specify enemy properties and behaviors",
      "options" : { collapsed: true },
      "properties": {
        "speedInitial": {
          "type": "integer",
          "title": "Initial speed",
          "headerTemplate": "Initial speed: {{self}}",
          "description": "The speed that enemies will move around when the world starts or resets",
          "default": 50,
          "minimum": 30,
          "maximum": 500,
          "multipleOf": 10,
          "format": "range"
        },        
        "respawn": {
          "type": "boolean",      
          "title": "Enemies respawn?",
          "description": "When true, enemies will come back to life after you shoot them",
          "default": true          
        },
        "speedIncreaseBy": {
          "type": "integer",
          "title": "Speed to add after respawning",
          "headerTemplate": "Speed to add after respawning: {{self}}",
          "default": 0,
          "description": "Specify how much additional speed the enemy will have each time it respawns after getting destroyed",
          "minimum": 0,
          "maximum": 100,
          "multipleOf": 5,          
          "format": "range"
        }
      }
    },
    "collisions": {
      "type": "object",
      "title": "Collision settings",
      "options" : { collapsed: true },            
      "description": "Specify what happens when collisions happen in your world",
      "properties": {
        "coin": {
          "type": "object",
          "title": "Coin",
          "description": "Specify what happens when you bump into coins",
          "properties": {
            "scoreInc": {
              "type": "integer",
              "title": "Points to add",
              "headerTemplate": "Points to add: {{self}}",
              "description": "Between 5 and 500",
              "default": 50,
              "minimum": 5,
              "maximum": 500,
              "format": "range"
            },
            "soundPlay": {
              "type": "string",
              "title": "Sound to play"
            }
          }
        },
        "gem": {
          "type": "object",
          "title": "Gem",
          "description": "Specify what happens when you bump into gems",          
          "properties": {
            "scoreInc": {
              "type": "integer",
              "title": "Ammo to add",
              "headerTemplate": "Ammo to add: {{self}}",
              "description": "Between 1 and 8",
              "default": 1,
              "minimum": 1,
              "maximum": 8,
              "format": "range"
            },
            "soundPlay": {
              "type": "string"
            }
          }
        }
      }
    },
    sprites: {
      'type': 'object',
      format: 'grid',
      "options" : { collapsed: true },            
      'title': 'Sprite settings',
      'description': 'Specify the sprites that will populate your world map',
      'properties': {}
    },
    world: {
      type: "array",
      format: "world",
      default: [
        ['e', 'g', 'c', 'c', 'c', 'g', 'g', 'c', 'c', 'c', 'e', 'g', 'c', 'c', 'c', 'c', 'c', 'c', 'g'],
        ['c', 'c', 't', 't', 'c', 't', 'c', 'c', 'c', 'c', 't', 't', 'c', 't', 't', 't', 'c', 't', 'c'],
        ['c', 'c', 't', 't', 'c', 't', 'g', 't', 't', 't', 't', 't', 'c', 'c', 'c', 'c', 'c', 't', 'c'],
        ['c', 'c', 't', 't', 'c', 't', 'c', 'c', 'c', 'c', 't', 't', 'c', 'c', 'c', 'c', 'c', 't', 'c'],
        ['c', 'c', 't', 'c', 'c', 't', 'c', 'c', 'c', 'c', 't', 't', 'c', 'c', 'c', 'c', 'c', 't', 'c'],
        ['c', 'c', 'g', 't', 'c', 't', 'c', 'c', 'c', 'g', 't', 't', 'c', 'c', 't', 't', 't', 't', 'c'],
        ['c', 'c', 't', 'c', 'c', 'c', 'c', 'c', 'c', 'c', 'c', 't', 'c', 'c', 'c', 'c', 'g', 't', 'c'],
        ['c', 'c', 't', 't', 'c', 'c', 'g', 'c', 'c', 'c', 't', 't', 'c', 't', 't', 't', 't', 't', 'c'],
        ['c', 'c', 'c', 't', 'c', 't', 't', 't', 'c', 'c', 'c', 't', 'c', 'c', 'c', 'c', 'c', 't', 'c'],
        ['c', 'c', 't', 'c', 'c', 't', 'c', 'c', 'c', 'c', 't', 't', 'c', 'c', 'c', 'c', 'c', 't', 'c'],
        ['c', 'c', 'c', 'c', 'c', 't', 'c', 'c', 'c', 'c', 't', 't', 'c', 'c', 'c', 't', 'c', 't', 'c'],
        ['c', 'c', 'p', 't', 'c', 'c', 'c', 'c', 'c', 'c', 'e', 't', 'c', 'c', 'c', 't', 'g', 't', 'g']
      ]
    }    
  }
};

var spriteParts = [
    {
        "part": "coin",
        "choices": [
            "coin/blue.png",
            "coin/brown.png",
            "coin/gold.png",
            "coin/green.png",
            "coin/light.png",
            "coin/pink.png"
        ],
        "sort": 4,
        "selected": "coin/blue.png",
        "_id": "tecyuojMfhZcD3juN"
    },
    {
        "part": "enemy",
        "choices": [
            "enemy/brainBlue.png",
            "enemy/brainPink.png",
            "enemy/cyclopsRed.png",
            "enemy/cyclopsYellow.png",
            "enemy/goonGreen.png",
            "enemy/goonPurple.png"
        ],
        "sort": 2,
        "selected": "enemy/brainBlue.png",
        "_id": "dZHGBrPzZQHQe7u4s"
    },
    {
        "part": "gem",
        "choices": [
            "gem/brightGem.png",
            "gem/diamondDark.png",
            "gem/diamondLight.png",
            "gem/emerald.png",
            "gem/pinkGem.png",
            "gem/ruby.png"
        ],
        "sort": 3,
        "selected": "gem/brightGem.png",
        "_id": "XoaxfJzuvq6izAjDF"
    },
    {
        "part": "player",
        "choices": [
            "player/dark.png",
            "player/light.png",
            "player/dark.png",
            "player/light.png",
            "player/dark.png",
            "player/light.png"
        ],
        "sort": 1,
        "selected": "player/dark.png",
        "_id": "3cABCsJm8FTAoykEL"
    },
    {
        "part": "tile",
        "choices": [
            "tile/fiery.png",
            "tile/golden.png",
            "tile/plasma.png",
            "tile/rockSmooth.png",
            "tile/rockSpeckled.png",
            "tile/rockSwirly.png"
        ],
        "sort": 5,
        "selected": "tile/fiery.png",
        "_id": "7tCygfFtpHcHdrtXq"
    }
];

_.each(spriteParts, function(item, index) {
  schema.properties.sprites.properties[item.part] = {
    title: item.part[0].toUpperCase() + item.part.substring(1),
    type: 'string',
    enum: item.choices
  }
});

// Initialize the editor with a JSON schema
var editor = new JSONEditor(document.getElementById('editor_holder'),{
  schema: schema,
  theme: 'bootstrap3',
  iconlib: 'fontawesome4',
  disable_edit_json: true,
  disable_properties: true,
  collapsed: true
});

function formatImage(val) {
  return "<img src='http://spaceminer.mod.bz/images/spriteParts/" + val.id + "' alt='" + val.id.split('/')[1] + "' title='" + val.id.split('/')[1] + "' />";
}

// Hook up the submit button to log to the console
document.getElementById('submit').addEventListener('click',function() {
  // Get the value from the editor
  var val = editor.getValue();

  var output = '';

  var sprites = JSON.parse(JSON.stringify(val.sprites));
  _.each(sprites, function(value, key) {
    sprites[key] = value.substring(value.indexOf('/') + 1);
  });

  var worldRows = _.map(val.world, function(row) {
    return row.join('');
  });

  output  += 'var worldName = "' + val.basics.worldName + '";\n'
          + 'var explorerName = "' + val.basics.explorerName + '";\n'
          + 'var numberOfLives = ' + val.basics.numberOfLives + ';\n'
          + 'var enableEnemyRespawn = ' + val.enemy.respawn + ';\n'
          + 'var sprites = ' + JSON.stringify(sprites, 2, '\t') + ';\n'
          + 'var worldRows = ' + JSON.stringify(worldRows, 2, '\t') + ';\n';

  console.log(output);          

});

_.each(schema.properties.sprites.properties, function(item, key) {
  $(editor.editors['root.sprites.' + key].select2).select2({
    formatResult: formatImage,
    formatSelection: formatImage,
    escapeMarkup: function(m) { return m; }
  });
});
    </script>
  </body>
</html>
